<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>tmap: JSS article reproduction code</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">tmap: JSS article reproduction code</h1>


<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#section-1.1" id="toc-section-1.1">Section 1.1</a></li>
<li><a href="#section-3.1" id="toc-section-3.1">Section 3.1</a></li>
<li><a href="#section-3.2" id="toc-section-3.2">Section 3.2</a></li>
<li><a href="#section-4.1" id="toc-section-4.1">Section 4.1</a></li>
<li><a href="#section-4.2" id="toc-section-4.2">Section 4.2</a></li>
<li><a href="#section-4.3" id="toc-section-4.3">Section 4.3</a></li>
<li><a href="#section-4.4" id="toc-section-4.4">Section 4.4</a></li>
<li><a href="#section-4.5" id="toc-section-4.5">Section 4.5</a></li>
</ul>
</div>

<div id="introduction" class="section level3">
<h3>Introduction</h3>
<p>The article <em>Tennekes, M. tmap: Thematic Maps in R (2018), Journal
of Statistical Software 84(6), 1-39,</em> <a href="http://dx.doi.org/10.18637/jss.v084.i06" class="uri">http://dx.doi.org/10.18637/jss.v084.i06</a> describes
version 1.x of tmap and tmaptools. Since tmap and tmaptools version 2.0
are based on <code>sf</code> objects instead of <code>sp</code> objects,
there are some changes in the code, especially regarding the necessary
processing step. The code for the plotting methods is fully backward
compatible, although some messages or warnings may be given for
deprecated functions or arguments.</p>
<p>This code replaces the script v84i06.R for tmap and tmaptools version
2.0. The produced figures are identical to those included in the
article.</p>
<p>See <a href="../doc/tmap-changes.html"><code>vignette(&quot;tmap-changes&quot;)</code></a>
for changes in version 2.x/3.x, which is recommended for people who have
read the JSS article. For people who are new to tmap, see <a href="../doc/tmap-getstarted.html"><code>vignette(&quot;tmap-getstarted&quot;)</code></a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="do">###########################################################################</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="do">## This script will replicate the figures (except the screenshots)</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="do">## and write them to files.</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="do">## The working directory should be set the the parent folder of this script.</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="do">###########################################################################</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="do">## install.packages(c(&quot;tmap&quot;, &quot;tmaptools&quot;))</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tmap&quot;</span>) <span class="co"># required version 2.0 or later</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;tmaptools&quot;</span>) <span class="co"># required version 2.0 or later</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;World&quot;</span>, <span class="st">&quot;metro&quot;</span>, <span class="at">package =</span> <span class="st">&quot;tmap&quot;</span>)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>metro<span class="sc">$</span>growth <span class="ot">&lt;-</span> (metro<span class="sc">$</span>pop2020 <span class="sc">-</span> metro<span class="sc">$</span>pop2010) <span class="sc">/</span> (metro<span class="sc">$</span>pop2010 <span class="sc">*</span> <span class="dv">10</span>) <span class="sc">*</span> <span class="dv">100</span></span></code></pre></div>
</div>
<div id="section-1.1" class="section level3">
<h3>Section 1.1</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="do">## Figure 1</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(World) <span class="sc">+</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(<span class="st">&quot;income_grp&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;-Blues&quot;</span>, </span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;Income class&quot;</span>, <span class="at">contrast =</span> <span class="fl">0.7</span>, <span class="at">border.col =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">id =</span> <span class="st">&quot;name&quot;</span>) <span class="sc">+</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>    <span class="fu">tm_text</span>(<span class="st">&quot;iso_a3&quot;</span>, <span class="at">size =</span> <span class="st">&quot;AREA&quot;</span>, <span class="at">col =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">root =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  <span class="fu">tm_shape</span>(metro) <span class="sc">+</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>    <span class="fu">tm_bubbles</span>(<span class="st">&quot;pop2010&quot;</span>, <span class="at">col =</span> <span class="st">&quot;growth&quot;</span>, <span class="at">border.col =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>      <span class="at">border.alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="cn">Inf</span>) ,</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>      <span class="at">palette =</span> <span class="st">&quot;-RdYlGn&quot;</span>,</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>      <span class="at">title.size =</span> <span class="st">&quot;Metro population (2010)&quot;</span>, </span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>      <span class="at">title.col =</span> <span class="st">&quot;Annual growth rate (%)&quot;</span>,</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>      <span class="at">id =</span> <span class="st">&quot;name&quot;</span>,</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>      <span class="at">popup.vars =</span> <span class="fu">c</span>(<span class="st">&quot;pop2010&quot;</span>, <span class="st">&quot;pop2020&quot;</span>, <span class="st">&quot;growth&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>  <span class="fu">tm_style</span>(<span class="st">&quot;gray&quot;</span>) <span class="sc">+</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>  <span class="fu">tm_format</span>(<span class="st">&quot;World&quot;</span>, <span class="at">frame.lwd =</span> <span class="dv">2</span>)</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="fu">tmap_save</span>(m1, <span class="st">&quot;bubble.png&quot;</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">height =</span> <span class="dv">3</span>, <span class="at">scale =</span> .<span class="dv">75</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">asp =</span> <span class="dv">0</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
</div>
<div id="section-3.1" class="section level3">
<h3>Section 3.1</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="do">## Figure 2</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(metro) <span class="sc">+</span> </span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="fu">tm_bubbles</span>(<span class="at">size =</span> <span class="st">&quot;pop2030&quot;</span>) <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="fu">tm_style</span>(<span class="st">&quot;cobalt&quot;</span>) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  <span class="fu">tm_format</span>(<span class="st">&quot;World&quot;</span>)</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="fu">tmap_save</span>(m0, <span class="st">&quot;metro2030.png&quot;</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">scale =</span> .<span class="dv">5</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
</div>
<div id="section-3.2" class="section level3">
<h3>Section 3.2</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="do">## Figure 3</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>m21 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(World) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span> <span class="fu">tm_layout</span>(<span class="at">frame.lwd =</span> <span class="fl">1.5</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">tmap_save</span>(m21, <span class="st">&quot;facets1.png&quot;</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">height =</span> <span class="fl">1.54</span>, <span class="at">scale =</span> .<span class="dv">75</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="do">## Figure 4</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>m22 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(World) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="st">&quot;red&quot;</span>) <span class="sc">+</span> <span class="fu">tm_facets</span>(<span class="at">by =</span> <span class="st">&quot;continent&quot;</span>, <span class="at">free.coords =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="fu">tmap_save</span>(m22, <span class="st">&quot;facets2.png&quot;</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">height =</span> <span class="fl">1.8</span>, <span class="at">scale =</span> .<span class="dv">75</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="do">## Figure 5</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>tm1 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(World) <span class="sc">+</span> <span class="fu">tm_polygons</span>()</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>tm2 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(metro) <span class="sc">+</span> <span class="fu">tm_dots</span>()</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="fu">png</span>(<span class="st">&quot;facets3.png&quot;</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">height =</span> <span class="fl">1.54</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>, <span class="at">res =</span> <span class="dv">300</span>)</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  <span class="fu">tmap_arrange</span>(tm1, tm2, <span class="at">outer.margins =</span> .<span class="dv">01</span>)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
</div>
<div id="section-4.1" class="section level3">
<h3>Section 4.1</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="do">## Figure 6</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&quot;view&quot;</span>)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>m1</span></code></pre></div>
</div>
<div id="section-4.2" class="section level3">
<h3>Section 4.2</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="do">## Figure 7</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;land&quot;</span>, <span class="st">&quot;rivers&quot;</span>, <span class="at">package =</span> <span class="st">&quot;tmap&quot;</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(land) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="st">&quot;elevation&quot;</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>, <span class="dv">250</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>, <span class="dv">2000</span>, <span class="dv">2500</span>, <span class="dv">3000</span>, <span class="dv">4000</span>, <span class="cn">Inf</span>),  </span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>            <span class="at">palette =</span> <span class="fu">terrain.colors</span>(<span class="dv">9</span>), <span class="at">title =</span> <span class="st">&quot;Elevation (m)&quot;</span>) <span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="fu">tm_shape</span>(rivers) <span class="sc">+</span> </span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="st">&quot;lightblue&quot;</span>, <span class="at">lwd =</span> <span class="st">&quot;strokelwd&quot;</span>, <span class="at">scale =</span> <span class="fl">1.5</span>, <span class="at">legend.lwd.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>  <span class="fu">tm_shape</span>(World, <span class="at">is.master =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="st">&quot;grey20&quot;</span>, <span class="at">lwd =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  <span class="fu">tm_grid</span>(<span class="at">projection =</span> <span class="st">&quot;longlat&quot;</span>, <span class="at">labels.size =</span> <span class="fl">0.4</span>, <span class="at">lwd =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>  <span class="fu">tm_text</span>(<span class="st">&quot;name&quot;</span>, <span class="at">size =</span> <span class="st">&quot;AREA&quot;</span>) <span class="sc">+</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="fl">0.08</span>, <span class="fl">0.45</span>), <span class="at">color.light =</span> <span class="st">&quot;grey90&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>  <span class="fu">tm_credits</span>(<span class="st">&quot;Eckert IV projection&quot;</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;RIGHT&quot;</span>, <span class="st">&quot;BOTTOM&quot;</span>)) <span class="sc">+</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>  <span class="fu">tm_style</span>(<span class="st">&quot;classic&quot;</span>,</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>         <span class="at">bg.color =</span> <span class="st">&quot;lightblue&quot;</span>,</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>         <span class="at">space.color =</span> <span class="st">&quot;grey90&quot;</span>,</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>         <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.04</span>, <span class="fl">0.04</span>, <span class="fl">0.03</span>, <span class="fl">0.02</span>), </span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>         <span class="at">earth.boundary =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>  <span class="fu">tm_legend</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;bottom&quot;</span>), </span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>            <span class="at">frame =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>            <span class="at">bg.color =</span> <span class="st">&quot;lightblue&quot;</span>)</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="fu">tmap_save</span>(m2, <span class="st">&quot;classic.png&quot;</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">scale =</span> .<span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
</div>
<div id="section-4.3" class="section level3">
<h3>Section 4.3</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="do">## Figure 8</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(World, <span class="at">projection =</span> <span class="st">&quot;robin&quot;</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="fu">c</span>(<span class="st">&quot;HPI&quot;</span>, <span class="st">&quot;gdp_cap_est&quot;</span>),</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>              <span class="at">palette =</span> <span class="fu">list</span>(<span class="st">&quot;RdYlGn&quot;</span>, <span class="st">&quot;Purples&quot;</span>),</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>              <span class="at">style =</span> <span class="fu">c</span>(<span class="st">&quot;pretty&quot;</span>, <span class="st">&quot;fixed&quot;</span>), <span class="at">n =</span> <span class="dv">7</span>, </span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>              <span class="at">breaks =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">500</span>, <span class="dv">2000</span>, <span class="dv">5000</span>, <span class="dv">10000</span>, <span class="dv">25000</span>, <span class="dv">50000</span>, <span class="cn">Inf</span>)),</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>              <span class="at">title =</span> <span class="fu">c</span>(<span class="st">&quot;Happy Planet Index&quot;</span>, <span class="st">&quot;GDP per capita&quot;</span>)) <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  <span class="fu">tm_style</span>(<span class="st">&quot;natural&quot;</span>, <span class="at">earth.boundary =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="sc">-</span><span class="dv">87</span>, <span class="dv">180</span>, <span class="dv">87</span>))  <span class="sc">+</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  <span class="fu">tm_format</span>(<span class="st">&quot;World&quot;</span>, <span class="at">inner.margins =</span> <span class="fl">0.02</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  <span class="fu">tm_legend</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;bottom&quot;</span>), <span class="at">bg.color =</span> <span class="st">&quot;gray95&quot;</span>, <span class="at">frame =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="fu">tm_credits</span>(<span class="fu">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;Robinson projection&quot;</span>), <span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;RIGHT&quot;</span>, <span class="st">&quot;BOTTOM&quot;</span>))</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>  </span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="fu">tmap_save</span>(m3, <span class="st">&quot;world_facets2.png&quot;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">scale =</span> .<span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
</div>
<div id="section-4.4" class="section level3">
<h3>Section 4.4</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="do">## Figure 9</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;readxl&quot;</span>)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;grid&quot;</span>)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co"># function to obtain Food Environment Atlas data (2014)</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>get_food_envir_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>()</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="fu">file.path</span>(dir, <span class="st">&quot;DataDownload.xls&quot;</span>))) {</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="fu">download.file</span>(<span class="st">&quot;https://www.ers.usda.gov/webdocs/DataFiles/48731/February2014.xls?v=41688&quot;</span>, <span class="at">destfile =</span> <span class="fu">file.path</span>(dir, <span class="st">&quot;DataDownload.xls&quot;</span>), <span class="at">mode =</span> <span class="st">&quot;wb&quot;</span>)</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  }</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="fu">read_excel</span>(<span class="fu">file.path</span>(dir, <span class="st">&quot;DataDownload.xls&quot;</span>), <span class="at">sheet =</span> <span class="st">&quot;HEALTH&quot;</span>)    </span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;The excel file cannot be read. Please open it, and remove all sheets except HEALTH. The location of the file is: &quot;</span>, <span class="fu">normalizePath</span>(<span class="fu">file.path</span>(dir, <span class="st">&quot;DataDownload.xls&quot;</span>)))</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>  })</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>}</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="co"># function to obtain US county shape</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>get_US_county_2010_shape <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>  dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>()</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="fu">download.file</span>(<span class="st">&quot;http://www2.census.gov/geo/tiger/GENZ2010/gz_2010_us_050_00_20m.zip&quot;</span>, <span class="at">destfile =</span> <span class="fu">file.path</span>(dir, <span class="st">&quot;gz_2010_us_050_00_20m.zip&quot;</span>))</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>  <span class="fu">unzip</span>(<span class="fu">file.path</span>(dir, <span class="st">&quot;gz_2010_us_050_00_20m.zip&quot;</span>), <span class="at">exdir =</span> dir)</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>  US <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(<span class="fu">file.path</span>(dir, <span class="st">&quot;gz_2010_us_050_00_20m.shp&quot;</span>))</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>  <span class="fu">levels</span>(US<span class="sc">$</span>NAME) <span class="ot">&lt;-</span> <span class="fu">iconv</span>(<span class="fu">levels</span>(US<span class="sc">$</span>NAME), <span class="at">from =</span> <span class="st">&quot;latin1&quot;</span>, <span class="at">to =</span> <span class="st">&quot;utf8&quot;</span>)</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>  US</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>}</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="co"># obtain Food Environment Atlas data</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>FEA <span class="ot">&lt;-</span> <span class="fu">get_food_envir_data</span>()</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a><span class="co"># obtain US county shape</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>US <span class="ot">&lt;-</span> <span class="fu">get_US_county_2010_shape</span>()</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>us1 <span class="ot">&lt;-</span> <span class="fu">qtm</span>(US)</span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a><span class="fu">tmap_save</span>(us1, <span class="st">&quot;US1.png&quot;</span>, <span class="at">scale =</span> .<span class="dv">5</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">asp =</span> <span class="dv">0</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a><span class="do">## Figure 10</span></span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>US<span class="sc">$</span>FIPS <span class="ot">&lt;-</span> <span class="fu">paste0</span>(US<span class="sc">$</span>STATE, US<span class="sc">$</span>COUNTY)</span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a><span class="co"># append data to shape</span></span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a><span class="co">#US &lt;- append_data(US, FEA, key.shp = &quot;FIPS&quot;, key.data = &quot;FIPS&quot;, ignore.duplicates = TRUE)</span></span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a>US <span class="ot">&lt;-</span> <span class="fu">left_join</span>(US, FEA, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;FIPS&quot;</span>, <span class="st">&quot;FIPS&quot;</span>))</span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a>unmatched_data <span class="ot">&lt;-</span> FEA <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>(FIPS <span class="sc">%in%</span> US<span class="sc">$</span>FIPS))</span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&quot;view&quot;</span>)</span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a><span class="fu">qtm</span>(US, <span class="at">fill =</span> <span class="st">&quot;PCT_OBESE_ADULTS10&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="do">## Figure 11</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>US_cont <span class="ot">&lt;-</span> US <span class="sc">%&gt;%</span> </span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="fu">subset</span>(<span class="sc">!</span>STATE <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;02&quot;</span>, <span class="st">&quot;15&quot;</span>, <span class="st">&quot;72&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="fu">simplify_shape</span>(<span class="fl">0.2</span>) </span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>US_AK <span class="ot">&lt;-</span> US <span class="sc">%&gt;%</span> </span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  <span class="fu">subset</span>(STATE <span class="sc">==</span> <span class="st">&quot;02&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  <span class="fu">simplify_shape</span>(<span class="fl">0.2</span>) </span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>US_HI <span class="ot">&lt;-</span> US <span class="sc">%&gt;%</span> </span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  <span class="fu">subset</span>(STATE <span class="sc">==</span> <span class="st">&quot;15&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>  <span class="fu">simplify_shape</span>(<span class="fl">0.2</span>) </span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co"># create state boundaries</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>US_states <span class="ot">&lt;-</span> US_cont <span class="sc">%&gt;%</span> </span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(geometry) <span class="sc">%&gt;%</span> </span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>    <span class="fu">aggregate</span>(<span class="at">by =</span> <span class="fu">list</span>(US_cont<span class="sc">$</span>STATE), <span class="at">FUN =</span> mean)</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a><span class="co"># contiguous US</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>m_cont <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(US_cont, <span class="at">projection =</span> <span class="dv">2163</span>) <span class="sc">+</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">&quot;PCT_OBESE_ADULTS10&quot;</span>, <span class="at">border.col =</span> <span class="st">&quot;gray50&quot;</span>, <span class="at">border.alpha =</span> .<span class="dv">5</span>, <span class="at">title =</span> <span class="st">&quot;&quot;</span>, <span class="at">showNA =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>  <span class="fu">tm_shape</span>(US_states) <span class="sc">+</span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>  <span class="fu">tm_credits</span>(<span class="st">&quot;Data @ Unites States Department of Agriculture</span><span class="sc">\n</span><span class="st">Shape @ Unites States Census Bureau&quot;</span>, <span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>)) <span class="sc">+</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">title =</span> <span class="st">&quot;2010 Adult Obesity by County, percent&quot;</span>, </span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>            <span class="at">title.position =</span> <span class="fu">c</span>(<span class="st">&quot;center&quot;</span>, <span class="st">&quot;top&quot;</span>), </span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;bottom&quot;</span>), </span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>            <span class="at">frame =</span> <span class="cn">FALSE</span>, </span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>            <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>))</span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a><span class="co"># Alaska inset</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>m_AK <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(US_AK, <span class="at">projection =</span> <span class="dv">3338</span>) <span class="sc">+</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">&quot;PCT_OBESE_ADULTS10&quot;</span>, <span class="at">border.col =</span> <span class="st">&quot;gray50&quot;</span>, <span class="at">border.alpha =</span> .<span class="dv">5</span>, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="at">by =</span> <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="st">&quot;Alaska&quot;</span>, <span class="at">legend.show =</span> <span class="cn">FALSE</span>, <span class="at">bg.color =</span> <span class="cn">NA</span>, <span class="at">title.size =</span> <span class="fl">0.8</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a><span class="co"># Hawaii inset</span></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>m_HI <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(US_HI, <span class="at">projection =</span> <span class="dv">3759</span>) <span class="sc">+</span></span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="st">&quot;PCT_OBESE_ADULTS10&quot;</span>, <span class="at">border.col =</span> <span class="st">&quot;gray50&quot;</span>, <span class="at">border.alpha =</span> .<span class="dv">5</span>, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="at">by =</span> <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="st">&quot;Hawaii&quot;</span>, <span class="at">legend.show =</span> <span class="cn">FALSE</span>, <span class="at">bg.color =</span> <span class="cn">NA</span>, <span class="at">title.position =</span> <span class="fu">c</span>(<span class="st">&quot;LEFT&quot;</span>, <span class="st">&quot;BOTTOM&quot;</span>), <span class="at">title.size =</span> <span class="fl">0.8</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a><span class="co"># specify viewports for Alaska and Hawaii</span></span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>vp_AK <span class="ot">&lt;-</span> <span class="fu">viewport</span>(<span class="at">x =</span> <span class="fl">0.15</span>, <span class="at">y =</span> <span class="fl">0.15</span>, <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">height =</span> <span class="fl">0.3</span>)</span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a>vp_HI <span class="ot">&lt;-</span> <span class="fu">viewport</span>(<span class="at">x =</span> <span class="fl">0.4</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="fl">0.1</span>)</span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a><span class="co"># save map</span></span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&quot;plot&quot;</span>)</span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a><span class="fu">tmap_save</span>(m_cont, <span class="st">&quot;USchoro.png&quot;</span>, <span class="at">scale =</span> <span class="fl">0.7</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>,</span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>          <span class="at">insets_tm =</span> <span class="fu">list</span>(m_AK, m_HI), </span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a>          <span class="at">insets_vp =</span> <span class="fu">list</span>(vp_AK, vp_HI))</span></code></pre></div>
</div>
<div id="section-4.5" class="section level3">
<h3>Section 4.5</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="do">## Figure 12a</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;sf&quot;</span>)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;rnaturalearth&quot;</span>)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co"># functions to obtain crimes data</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>get_crimes_data <span class="ot">&lt;-</span> <span class="cf">function</span>(path) {</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">file.exists</span>(path), (<span class="st">&quot;crimes_in_Greater_London_2015-10.zip&quot;</span> <span class="sc">%in%</span> <span class="fu">list.files</span>(path)))</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  tmp_dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>()</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="fu">unzip</span>(<span class="fu">file.path</span>(path, <span class="st">&quot;crimes_in_Greater_London_2015-10.zip&quot;</span>), <span class="at">exdir =</span> tmp_dir)</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  <span class="fu">rbind</span>(<span class="fu">read.csv</span>(<span class="fu">file.path</span>(tmp_dir, <span class="st">&quot;2015-10-city-of-london-street.csv&quot;</span>)),</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>        <span class="fu">read.csv</span>(<span class="fu">file.path</span>(tmp_dir, <span class="st">&quot;2015-10-metropolitan-street.csv&quot;</span>)))</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>}</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="co"># please download the file &quot;crimes_in_Greater_London_2015-10.zip&quot; (available on https://www.jstatsoft.org as a supplement of this paper), and change the path argument below to the location of the downloaded file:</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>crimes <span class="ot">&lt;-</span> <span class="fu">get_crimes_data</span>(<span class="at">path =</span> <span class="st">&quot;./&quot;</span>)</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a><span class="co"># create sf of known locations</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>crimes <span class="ot">&lt;-</span> crimes[<span class="sc">!</span><span class="fu">is.na</span>(crimes<span class="sc">$</span>Longitude) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(crimes<span class="sc">$</span>Latitude), ]</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>crimes <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(crimes, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;Longitude&quot;</span>, <span class="st">&quot;Latitude&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a><span class="co"># set map projection to British National Grid</span></span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>crimes <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(crimes, <span class="at">crs =</span> <span class="dv">27700</span>)</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>c1 <span class="ot">&lt;-</span> <span class="fu">qtm</span>(crimes)</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a><span class="fu">tmap_save</span>(c1, <span class="st">&quot;crimes1.png&quot;</span>, <span class="at">scale =</span> .<span class="dv">6</span>, <span class="at">width =</span> <span class="dv">3</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="do">## Figure 12b</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>crimes_osm <span class="ot">&lt;-</span> <span class="fu">read_osm</span>(crimes)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>c2 <span class="ot">&lt;-</span> <span class="fu">qtm</span>(crimes_osm) <span class="sc">+</span> <span class="fu">qtm</span>(crimes, <span class="at">symbols.col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">symbols.size =</span> <span class="fl">0.5</span>)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="fu">tmap_save</span>(c2, <span class="st">&quot;crimes2.jpg&quot;</span>, <span class="at">scale =</span> .<span class="dv">6</span>, <span class="at">width =</span> <span class="dv">3</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="do">## Figure 13</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>c3 <span class="ot">&lt;-</span> <span class="fu">qtm</span>(crimes_osm, <span class="at">raster.saturation =</span> <span class="dv">0</span>, <span class="at">raster.alpha =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="fu">qtm</span>(crimes, <span class="at">symbols.col =</span> <span class="st">&quot;Crime.type&quot;</span>, <span class="at">symbols.size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  <span class="fu">tm_legend</span>(<span class="at">outside =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="fu">tmap_save</span>(c3, <span class="st">&quot;crimes3.png&quot;</span>, <span class="at">scale =</span> .<span class="dv">8</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">4</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="do">## Figure 14</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>regions <span class="ot">&lt;-</span> <span class="fu">ne_download</span>(<span class="at">scale =</span> <span class="st">&quot;large&quot;</span>, <span class="at">type =</span> <span class="st">&quot;states&quot;</span>, <span class="at">category =</span> <span class="st">&quot;cultural&quot;</span>, <span class="at">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>london <span class="ot">&lt;-</span> regions[<span class="fu">which</span>(regions<span class="sc">$</span>region <span class="sc">==</span> <span class="st">&quot;Greater London&quot;</span>),]</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>london <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(london, <span class="at">crs =</span> <span class="dv">27700</span>)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co"># remove crimes outside Greater London</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>crimes_london <span class="ot">&lt;-</span> <span class="fu">crop_shape</span>(crimes, london, <span class="at">polygon =</span>  <span class="cn">TRUE</span>)</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>c3b <span class="ot">&lt;-</span> <span class="fu">qtm</span>(crimes_london, <span class="at">dots.alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  <span class="fu">tm_shape</span>(london) <span class="sc">+</span> </span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>  <span class="fu">tm_borders</span>()</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="fu">tmap_save</span>(c3b, <span class="st">&quot;crimes3b.png&quot;</span>, <span class="at">scale =</span> .<span class="dv">7</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="do">## Figure 15</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;devtools&quot;</span>)</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="fu">install_github</span>(<span class="st">&quot;mtennekes/oldtmaptools&quot;</span>)</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="fu">library</span>(oldtmaptools)</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>crime_densities <span class="ot">&lt;-</span> <span class="fu">smooth_map</span>(crimes_london, <span class="at">bandwidth =</span> <span class="fl">0.5</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">250</span>, <span class="dv">500</span>, <span class="dv">1000</span>), <span class="at">cover =</span> london)</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="co"># download rivers, and get Thames shape</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>rivers <span class="ot">&lt;-</span> <span class="fu">ne_download</span>(<span class="at">scale =</span> <span class="st">&quot;large&quot;</span>, <span class="at">type =</span> <span class="st">&quot;rivers_lake_centerlines&quot;</span>, <span class="at">category =</span> <span class="st">&quot;physical&quot;</span>)</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>thames <span class="ot">&lt;-</span> <span class="fu">crop_shape</span>(rivers, london)</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>c4 <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(crime_densities<span class="sc">$</span>polygons) <span class="sc">+</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">col =</span> <span class="st">&quot;level&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;YlOrRd&quot;</span>, <span class="at">title =</span> <span class="fu">expression</span>(<span class="st">&quot;Crimes per &quot;</span> <span class="sc">*</span> km<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">+</span> </span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>  <span class="fu">tm_shape</span>(london) <span class="sc">+</span> <span class="fu">tm_borders</span>() <span class="sc">+</span></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>  <span class="fu">tm_shape</span>(thames) <span class="sc">+</span> <span class="fu">tm_lines</span>(<span class="at">col =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">lwd =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>  <span class="fu">tm_compass</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;bottom&quot;</span>)) <span class="sc">+</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">position =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;bottom&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>  <span class="fu">tm_style</span>(<span class="st">&quot;gray&quot;</span>, <span class="at">title =</span> <span class="st">&quot;Crimes in Greater London</span><span class="sc">\n</span><span class="st">October 2015&quot;</span>)</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a><span class="fu">tmap_save</span>(c4, <span class="st">&quot;crimes4.png&quot;</span>, <span class="at">scale =</span> .<span class="dv">7</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="do">## Figure 16</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>london_city <span class="ot">&lt;-</span> london[london<span class="sc">$</span>name <span class="sc">==</span> <span class="st">&quot;City&quot;</span>,]</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>crimes_city <span class="ot">&lt;-</span> <span class="fu">crop_shape</span>(crimes_london, london_city, <span class="at">polygon =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>london_osm <span class="ot">&lt;-</span> <span class="fu">read_osm</span>(london_city, <span class="at">type =</span> <span class="st">&quot;stamen-watercolor&quot;</span>, <span class="at">zoom =</span> <span class="dv">13</span>)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>c5 <span class="ot">&lt;-</span> <span class="fu">qtm</span>(london_osm) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  <span class="fu">tm_shape</span>(crimes_city) <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">size =</span> .<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="st">&quot;Crime.type&quot;</span>, <span class="at">free.coords =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="fu">tmap_save</span>(c5, <span class="st">&quot;crimes5.png&quot;</span>, <span class="at">scale =</span> <span class="dv">1</span>, <span class="at">width =</span> <span class="fl">6.125</span>, <span class="at">asp =</span> <span class="cn">NA</span>, <span class="at">outer.margins =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="do">## Figure 17</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>crime_lookup <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Anti-social behaviour&quot;</span> <span class="ot">=</span> <span class="dv">2</span>, </span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>                  <span class="st">&quot;Bicycle theft&quot;</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>                  <span class="st">&quot;Burglary&quot;</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>                  <span class="st">&quot;Criminal damage and arson&quot;</span> <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>                  <span class="st">&quot;Drugs&quot;</span> <span class="ot">=</span> <span class="dv">6</span>, </span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>                  <span class="st">&quot;Other crime&quot;</span> <span class="ot">=</span> <span class="dv">7</span>,</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>                  <span class="st">&quot;Other theft&quot;</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>                  <span class="st">&quot;Possession of weapons&quot;</span> <span class="ot">=</span> <span class="dv">3</span>, </span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>                  <span class="st">&quot;Public order&quot;</span> <span class="ot">=</span> <span class="dv">2</span>, </span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>                  <span class="st">&quot;Robbery&quot;</span> <span class="ot">=</span> <span class="dv">1</span>, </span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>                  <span class="st">&quot;Shoplifting&quot;</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>                  <span class="st">&quot;Theft from the person&quot;</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>                  <span class="st">&quot;Vehicle crime&quot;</span> <span class="ot">=</span> <span class="dv">4</span>,</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>                  <span class="st">&quot;Violence and sexual offences&quot;</span> <span class="ot">=</span> <span class="dv">5</span>)</span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>crime_categories <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Property Crime&quot;</span>,</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>                      <span class="st">&quot;Criminal damage and anti-social behaviour&quot;</span>,</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>                      <span class="st">&quot;Possession of weapons&quot;</span>,</span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>                      <span class="st">&quot;Vehicle crime&quot;</span>,</span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>                      <span class="st">&quot;Violence and sexual offences&quot;</span>,</span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a>                      <span class="st">&quot;Drugs&quot;</span>,</span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a>                      <span class="st">&quot;Other crime&quot;</span>)</span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a>crimes_city<span class="sc">$</span>Crime.group <span class="ot">&lt;-</span> <span class="fu">factor</span>(crime_lookup[crimes_city<span class="sc">$</span>Crime.type], <span class="at">labels =</span> crime_categories)</span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&quot;view&quot;</span>)</span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a><span class="fu">tm_shape</span>(crimes_city) <span class="sc">+</span></span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">jitter =</span> <span class="fl">0.2</span>, <span class="at">col =</span> <span class="st">&quot;Crime.group&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;Dark2&quot;</span>, <span class="at">popup.vars =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a>  <span class="fu">tm_view</span>(<span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a>    <span class="at">basemaps =</span> <span class="st">&quot;Esri.WorldTopoMap&quot;</span>)</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
